type: custom:apexcharts-card
header:
  show: true
  title: Electricity prices
  show_states: true
  colorize_states: true
graph_span: 48h
span:
  start: day
  offset: +0h
now:
  show: true
  color: var(--accent-color)
  label: Now
apex_config:
  chart:
    height: 250
    stacked: false
    toolbar:
      show: false
  legend:
    show: false
  grid:
    show: true
    borderColor: var(--divider-color)
  tooltip:
    fixed:
      enabled: true
      position: topLeft
    offsetX: -10
    offsetY: -10
    shared: false
    x:
      format: MMM dd, HH:mm
    "y":
      formatter: >
        EVAL:function(value){if(value===null||typeof
        value==='undefined'||Number.isNaN(Number(value)))return'';return
        Number(value).toFixed(6)+' €/kWh';}
  xaxis:
    type: datetime
    tickAmount: 48
    labels:
      format: HH:mm
      datetimeUTC: false
      rotate: -45
      offsetX: 0
      offsetY: 0
      timezone: Europe/Tallinn
  yaxis:
    - title:
        text: Price (€/kWh)
      labels:
        formatter: >
          EVAL:function(value){if(value===null||typeof
          value==='undefined'||Number.isNaN(Number(value)))return'';return
          Number(value).toFixed(6)+' €';}
      min: 0
  colors:
    - var(--primary-color)
    - var(--success-color)
    - var(--warning-color)
  plotOptions:
    bar:
      columnWidth: 160%
      endingShape: square
  dataLabels:
    enabled: false
  stroke:
    width: 0
  fill:
    opacity: 1
series:
  - entity: sensor.real_electricity_price_current_price
    name: Current
    type: line
    stroke_width: 0
    float_precision: 2
    unit: €/kWh
    data_generator: >
      var out = [];

      var now = new Date();

      now.setMinutes(0, 0, 0);

      var nowts = now.getTime();

      var v = null;

      if (entity && entity.state && entity.state !== 'unknown' && entity.state
      !== 'unavailable') {
        v = Number(entity.state);
      }

      out.push([nowts, v]);

      return out;
  - entity: sensor.real_electricity_price_hourly_prices_today
    type: column
    name: Hourly Prices (Today)
    float_precision: 6
    unit: €/kWh
    color: var(--success-color)
    show:
      in_header: false
    data_generator: |
      if (!entity || !entity.attributes) return [];
      var arr = entity.attributes.hourly_prices;
      if (!arr || !Array.isArray(arr)) return [];
      var out = [];
      for (var j = 0; j < arr.length; j++) {
        var it = arr[j];
        if (it && it.start_time) {
          var ts = new Date(it.start_time).getTime();
          var v = (typeof it.actual_price !== 'undefined' && it.actual_price !== null) 
                  ? Number(it.actual_price) 
                  : (typeof it.nord_pool_price !== 'undefined' && it.nord_pool_price !== null 
                     ? Number(it.nord_pool_price) 
                     : null);
          out.push([ts, v]);
        }
      }
      return out;
  - entity: sensor.real_electricity_price_hourly_prices_tomorrow
    type: column
    name: Hourly Prices (Tomorrow)
    float_precision: 6
    unit: €/kWh
    color: var(--warning-color)
    show:
      in_header: false
    data_generator: |
      if (!entity || !entity.attributes) return [];
      var arr = entity.attributes.hourly_prices;
      if (!arr || !Array.isArray(arr)) return [];
      var out = [];
      for (var j = 0; j < arr.length; j++) {
        var it = arr[j];
        if (it && it.start_time) {
          var ts = new Date(it.start_time).getTime();
          var v = (typeof it.actual_price !== 'undefined' && it.actual_price !== null) 
                  ? Number(it.actual_price) 
                  : (typeof it.nord_pool_price !== 'undefined' && it.nord_pool_price !== null 
                     ? Number(it.nord_pool_price) 
                     : null);
          out.push([ts, v]);
        }
      }
      return out;
